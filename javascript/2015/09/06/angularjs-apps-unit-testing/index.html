<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yet another tech blog!">

    <title>AngularJS 单元测试 - George's Code Thoughts</title>

    <link rel="canonical" href="http://codethoughts.info/javascript/2015/09/06/angularjs-apps-unit-testing/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <link href='//fonts.useso.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">George's Code Thoughts</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About me</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>AngularJS 单元测试</h1>
                    
                    <span class="meta">Posted by George Sun on September 6, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h2 id="section">简介</h2>

<p>AngularJS 起初由 Google 的一位测试工程师 Misko Hevery编写。在设计之初，易于为应用程序编写测试就是 AngularJS 的核心设计目标之一。 我们知道，在为应用程序编写测试的时候，最困难的部分就是管理应用程序外部依赖，AngularJS 通过模块化和依赖注入使得管理依赖变成一件轻松的事情。另外，AngularJS 可以轻松和第三方的测试框架和类库集成，比如：Mocha/Chai/Sinon，Jasmine，这也是为前端应用开发测试代码的另一个利好，你没必要再去熟悉新的框架或者类库。我在另一篇博客中介绍了如何使用 <a href="http://codethoughts.info/javascript/2015/07/18/javascript-bdd-with-mocha-chai-sinon/">用 Mocha/Chai/Sinon 测试 JavaScript 代码</a>，它着重介绍了如何测试 JavaScript 代码。然而编写 AngularJS 的单元测试又需要学习一些新的知识，这也是这篇文章要讨论的主题。</p>

<p>本文假定你知道什么是单元测试，熟悉 AngularJS 的基本概念，比如 Module，Controller，Service，Directive，依赖注入等。如果这时候你仍然不清楚，可以参考<a href="http://codethoughts.info/angular.js/2015/05/15/things-i-wish-i-were-told-about-angular-js/">关于 Angular.js 你需要知道的知识</a> 和 <a href="http://codethoughts.info/javascript/2015/07/18/javascript-bdd-with-mocha-chai-sinon/">用 Mocha/Chai/Sinon 测试 JavaScript 代码</a> 这两篇文章，或者自行 <a href="www.google.com">Google</a>。</p>

<p>AngularJS 的测试又可以大致分为单元测试和 E2E 测试，本文将不会涉及 E2E 测试，感兴趣的同学可以参考 <a href="https://angular.github.io/protractor/#/">Protractor 主页</a>。</p>

<p>本文中测试代码将使用 Mocha/Chai/Sinon 测试类库来编写。当然了，你也可以使用 Jasmine，两者的功能基本一致，只是语法略有区别。Jasmine 是一栈式的测试框架，而 Mocha/Chai/Sinon 的组合方案更具灵活性。</p>

<h2 id="section-1">设置测试环境</h2>

<p>设置一个基本的测试环境需要安装几个 NPM 包，我们一一过一遍。</p>

<h3 id="karma">安装/配置 Karma</h3>

<p>在这篇文章里我使用 <a href="http://karma-runner.github.io/0.13/index.html">Karma</a> 来驱动 AngularJS 的单元测试。从它主页的简介可以看出，Karma 可以用来启动一个应用服务器，并在其中运行测试代码和需要被测试的源码，并把测试结果打印到命令行。另外它还具有一些对 TDD 很有帮助的功能，比如监控文件夹下的文件变动，并自动运行对应的测试代码。安装 Karma 很简单：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mkdir angularjs-unit-testing <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="nv">$_</span>
<span class="nv">$ </span>npm init <span class="c">## use default configuration</span>
<span class="nv">$ </span>npm install -g karma-cli
<span class="nv">$ </span>npm install -D karma karma-mocha karma-chai karma-phantomjs-launcher karma-sinon-chai karma-coverage
<span class="nv">$ </span>karma init</code></pre></div>

<p>首先我们安装了一个全局的 Karma 命令行工具，然后安装了所需的依赖，最后，运行 <code>karma init</code> 来生成Karma 配置文件。Karma 启动的时候，会默认寻找 <code>karma.conf.js</code> 配置文件，我们要做的就是在项目根目录下运行 <code>karma init</code>，并填入我们所需要的配置。关于每个配置项的含义，可以参考 <a href="http://karma-runner.github.io/0.8/config/configuration-file.html">Karma 文档</a>。</p>

<p>我们的 Karma 配置文件内容如下：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Karma configuration</span>
<span class="c1">// Generated on Sun Sep 06 2015 11:33:08 GMT+0800 (CST)</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>

    <span class="c1">// base path used to resolve all patterns (e.g. files, exclude)</span>
    <span class="nx">basePath</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>

    <span class="c1">// frameworks to use</span>
    <span class="nx">frameworks</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;mocha&#39;</span><span class="p">,</span> <span class="s1">&#39;sinon-chai&#39;</span><span class="p">],</span>

    <span class="c1">// list of files / patterns to load in the browser</span>
    <span class="nx">files</span><span class="o">:</span> <span class="p">[</span>
      <span class="s1">&#39;bower_components/angular/angular.js&#39;</span><span class="p">,</span>
      <span class="s1">&#39;bower_components/angular-mocks/angular-mocks.js&#39;</span><span class="p">,</span>
      <span class="s1">&#39;src/*.js&#39;</span><span class="p">,</span>
      <span class="s1">&#39;test/*.mocha.js&#39;</span>
    <span class="p">],</span>

    <span class="c1">// list of files to exclude</span>
    <span class="nx">exclude</span><span class="o">:</span> <span class="p">[],</span>

    <span class="c1">// preprocess matching files before serving them to the browser</span>
    <span class="nx">preprocessors</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;src/*.js&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;coverage&#39;</span><span class="p">]</span>
    <span class="p">},</span>

    <span class="nx">coverageReporter</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text-summary&#39;</span><span class="p">,</span>
      <span class="nx">dir</span><span class="o">:</span> <span class="s1">&#39;coverage/&#39;</span>
    <span class="p">},</span>

    <span class="c1">// test results reporter to use</span>
    <span class="nx">reporters</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="s1">&#39;coverage&#39;</span><span class="p">],</span>

    <span class="c1">// web server port</span>
    <span class="nx">port</span><span class="o">:</span> <span class="mi">9876</span><span class="p">,</span>

    <span class="c1">// enable / disable colors in the output (reporters and logs)</span>
    <span class="nx">colors</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

    <span class="c1">// level of logging</span>
    <span class="nx">logLevel</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">LOG_INFO</span><span class="p">,</span>

    <span class="c1">// enable / disable watching file and executing tests on file changes</span>
    <span class="nx">autoWatch</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

    <span class="c1">// start these browsers</span>
    <span class="nx">browsers</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;PhantomJS&#39;</span><span class="p">],</span>

    <span class="c1">// Continuous Integration mode</span>
    <span class="c1">// if true, Karma captures browsers, runs the tests and exits</span>
    <span class="nx">singleRun</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">});</span>
<span class="p">};</span></code></pre></div>

<p>接下来我们用 <a href="http://bower.io/">Bower</a> 来安装 AngularJS 和 angular-mocks。</p>

<h3 id="bower--angularjs--angular-mocks">用 Bower 安装 AngularJS 和 angular-mocks</h3>

<p>注意我们在测试代码中通过 <code>angular-mocks.js</code> 指定了 <a href="https://docs.angularjs.org/api/ngMock">ngMock</a>。ngMock 为 AngularJS 应用提供了很多测试工具方法，可以通过它来进行依赖注入和模块依赖管理，回头我们还会介绍到。AngularJS 和 angular-mocks 可以通过 Bower 来安装：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>bower init <span class="c"># with default configuration</span>
<span class="nv">$ </span>bower install angular --save
<span class="nv">$ </span>bower install angular-mocks --save-dev</code></pre></div>

<p><code>bower.json</code> 内容如下：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;angularjs-unit-testing&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.0.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;authors&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;George Sun &lt;sunwinner3@gmail.com&gt;&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;license&quot;</span><span class="o">:</span> <span class="s2">&quot;MIT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;homepage&quot;</span><span class="o">:</span> <span class="s2">&quot;http://www.codethoughts.info&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ignore&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;**/.*&quot;</span><span class="p">,</span>
    <span class="s2">&quot;node_modules&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bower_components&quot;</span><span class="p">,</span>
    <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tests&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;angular&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.4.5&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;devDependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;angular-mocks&quot;</span><span class="o">:</span> <span class="s2">&quot;~1.4.5&quot;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>关于 Mocha/Chai/Sinon，可以参考我的另一篇文章：<a href="http://codethoughts.info/javascript/2015/07/18/javascript-bdd-with-mocha-chai-sinon/">用 Mocha/Chai/Sinon 测试 JavaScript 代码</a> ，这里不再赘述。</p>

<p>到此，我们的测试环境基本设置已经完成，下面我们来看看如何测试用 AngularJS 框架编写的各个组件。</p>

<h2 id="angularjs-">测试 AngularJS 应用程序</h2>
<p>AngularJS 框架鼓励开发者通过模块来组织代码，它通过 <code>module</code> 来定义和解析模块的依赖，可能是其他的模块。 同样 angular-mocks 也可以利用 <code>module(...)</code> 来查找所依赖的模块。比如：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;myCustomModule&#39;</span><span class="p">));</span></code></pre></div>

<p>这段代码会在每个测试用例（通过 <code>it</code> 定义）运行之前查找所依赖的模块，如果所查找的模块不存在，那么这段代码会抛出异常。有了这个工具，我们通过实例来看看如何测试 AngularJS 应用程序的 Services, Controllers, Directives 等等。</p>

<h3 id="service">测试 Service</h3>

<p>Service 在 AngularJS 框架中泛指 Filter，Service，Factory 等几个子类，它们都可以看做面向对象设计中的单例模式。通常来说，Service 是比较易于测试的，因为 Service 所依赖的一般是其他 Service，它们可以通过依赖注入来管理和模拟（Mock），AngularJS 的设计使得注入其他 Service 工作变得异常简单，我们通过一个 Factory 实例来看看。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;factories&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;factoryUT&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$log&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$log</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">ook</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Ook.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}]);</span></code></pre></div>

<p>这里我们需要注入 <code>$log</code>，我也同样可以在测试代码中注入它：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;factories&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;factories&#39;</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">factoryUT</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">$log</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_factoryUT_</span><span class="p">,</span> <span class="nx">_$log_</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">factoryUT</span> <span class="o">=</span> <span class="nx">_factoryUT_</span><span class="p">;</span>
        <span class="nx">$log</span> <span class="o">=</span> <span class="nx">_$log_</span><span class="p">;</span>
        <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">$log</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
    <span class="p">}));</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;when invoked&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">factoryUT</span><span class="p">.</span><span class="nx">ook</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should say Ook&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">$log</span><span class="p">.</span><span class="nx">warn</span><span class="p">.</span><span class="nx">callCount</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">$log</span><span class="p">.</span><span class="nx">warn</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Ook.&#39;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>这里特别需要注意的是 <code>_factoryUT_</code> 和 <code>_$log_</code>，它们都是 AngularJS 的一种使用惯例，通过下划线包装需要注入的模块，在依赖解析的时候，<code>angular-mocks</code> 会自动去除两端的下划线，详情可以参考 <a href="https://docs.angularjs.org/api/ngMock/function/angular.mock.inject">Resolving References (Underscore Wrapping)</a>。</p>

<p>另外，我们使用 <code>sinon.stub()</code> 来为 <code>$log.warn()</code> 模拟函数的实现，AngularJS 通过依赖注入给我们带来的好处在这里得到了充分体现。</p>

<h3 id="controller">测试 Controller</h3>

<p>AngularJS 是 MVC 架构，或者说是 MVW（Model-View-Whatever）架构。在 AngularJS 应用中，<code>controller</code> 被用作 Model 和 View 之间的代理。通过 controller，我们可以在上述两个组件之间传递状态和行为。下面我们通过一个在线文本编辑器实例来演示如何测试 AngularJS 的 controller 组件：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;textEditor&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;EditionCtrl&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$scope&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span><span class="nx">toolbarVisible</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">documentSaved</span><span class="o">:</span> <span class="kc">true</span><span class="p">};</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nb">document</span> <span class="o">=</span> <span class="p">{</span><span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Some text&#39;</span><span class="p">};</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="s1">&#39;document.text&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">documentSaved</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span> <span class="kc">true</span><span class="p">);</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">saveDocument</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">sendHTTP</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">documentSaved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">$scope</span><span class="p">.</span><span class="nx">sendHTTP</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// payload creation, HTTP request, etc.</span>
    <span class="p">};</span>
<span class="p">}]);</span></code></pre></div>

<p>上面代码中，<code>state</code> 状态可能被 View 层或者 Controller 代码修改，<code>$scope.$watch</code> 会通过监控状态变化来更新文档是否被保存的状态。另外， <code>toolbarVisible</code> 可能被 View 层的鼠标或者键盘事件所修改，这是我们在单元测试中所不能覆盖的，它需要 E2E 测试来覆盖。</p>

<p>测试代码如下：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;saving a document&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">scope</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ctrl</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;textEditor&#39;</span><span class="p">));</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$controller</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scope</span> <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$new</span><span class="p">();</span>
        <span class="nx">ctrl</span> <span class="o">=</span> <span class="nx">$controller</span><span class="p">(</span><span class="s1">&#39;EditionCtrl&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">$scope</span><span class="o">:</span> <span class="nx">scope</span><span class="p">});</span>
    <span class="p">}));</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should have an initial documentSaved state&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">expect</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">documentSaved</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;documentSaved property&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// We don&#39;t want extra HTTP requests to be sent</span>
            <span class="c1">// and that&#39;s not what we&#39;re testing here.</span>
            <span class="nx">sinon</span><span class="p">.</span><span class="nx">stub</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="s1">&#39;sendHTTP&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>

            <span class="c1">// A call to $apply() must be performed, otherwise the</span>
            <span class="c1">// scope&#39;s watchers won&#39;t be run through.</span>
            <span class="nx">scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">text</span> <span class="o">+=</span> <span class="s1">&#39; And some more text&#39;</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should watch for document.text changes&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">documentSaved</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;when calling the saveDocument function&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">scope</span><span class="p">.</span><span class="nx">saveDocument</span><span class="p">();</span>
            <span class="p">});</span>

            <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be set to true again&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">documentSaved</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">afterEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">sendHTTP</span><span class="p">.</span><span class="nx">callCount</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nx">sendHTTP</span><span class="p">.</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">scope</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>测试代码中比较有趣的地方是我们模拟了发送 HTTP 请求的方法，这样可以加速测试代码的运行速度，因为我们不需要发送真正的 HTTP 请求。在这里，请求的相应内容我们并不关心，我们只是每次返回同样的内容，并通过 <code>$scope.$apply()</code> 来触发一次文档保存动作。另外，我们也可以看到应该如何注入 <code>$scope</code> 和 <code>$controller</code> 依赖，并通过注入的 <code>$controller</code> 来查找我们所需要的 Controller。</p>

<p>关于 Controller 测试我们就介绍这么多，接下来看看如何测试 Directive。</p>

<h3 id="directive">测试 Directive</h3>

<p>Directive 是 AngularJS 中最重要的概念。通过 Directive，我们可以通过模块化的代码来扩展 HTML，并在模块中封装行为和状态。Directive 通常是隔离的命名空间（isolated scope），所以在测试中我们可以把它当做一个黑盒子来看待，仅仅通过它暴露的接口还和它交互。下面我们通过一个实例来看看如何测试 Directive。</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;myDirectives&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;superButton&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="o">:</span> <span class="p">{</span><span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="s1">&#39;&amp;onClick&#39;</span><span class="p">},</span>
        <span class="nx">replace</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
        <span class="nx">link</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// do nothing.</span>
        <span class="p">},</span>
        <span class="nx">template</span><span class="o">:</span> <span class="s1">&#39;&lt;div&gt;&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;&lt;button ng-click=&quot;callback()&quot;&gt;Click me!&lt;/button&gt;&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;&lt;/div&gt;&#39;</span>
    <span class="p">};</span>
<span class="p">});</span></code></pre></div>

<p>上面的代码定义了一个按钮，我们可以通过 <code>$scope</code> 给它指定标签和行为，它们也是我们想要测试的地方。事实上，测试 Directive 的责任更多应该由 E2E 测试来承担，但是我们希望在单元测试中包括尽可能多的测试用例。这样我们可以尽快得到代码和行为是否正确的反馈。单元测试代码如下：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;directives&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;myDirectives&#39;</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">element</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">outerScope</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">innerScope</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$compile</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">element</span><span class="p">(</span><span class="s1">&#39;&lt;super-button label=&quot;myLabel&quot; on-click=&quot;myCallback()&quot;&gt;&lt;/super-button&gt;&#39;</span><span class="p">);</span>

        <span class="nx">outerScope</span> <span class="o">=</span> <span class="nx">$rootScope</span><span class="p">;</span>
        <span class="nx">$compile</span><span class="p">(</span><span class="nx">element</span><span class="p">)(</span><span class="nx">outerScope</span><span class="p">);</span>

        <span class="nx">innerScope</span> <span class="o">=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">isolateScope</span><span class="p">();</span>

        <span class="nx">outerScope</span><span class="p">.</span><span class="nx">$digest</span><span class="p">();</span>
    <span class="p">}));</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">outerScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">outerScope</span><span class="p">.</span><span class="nx">myLabel</span> <span class="o">=</span> <span class="s2">&quot;Hello world.&quot;</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be rendered&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">expect</span><span class="p">(</span><span class="nx">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">&#39;Hello world.&#39;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;click callback&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mySpy</span><span class="p">;</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">mySpy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
            <span class="nx">outerScope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">outerScope</span><span class="p">.</span><span class="nx">myCallback</span> <span class="o">=</span> <span class="nx">mySpy</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;when the directive is clicked&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s2">&quot;MouseEvent&quot;</span><span class="p">);</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">initMouseEvent</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be called&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">mySpy</span><span class="p">.</span><span class="nx">callCount</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>上面代码正是测试了按钮的标签和行为。这里需要注意 <code>$compile</code> 的用法，<code>$compile</code> 可以把字符串或者 DOM 编译为模板，它返回一个模板函数，随后我们使用该函数绑定 <code>$scope</code> 和状态。详细的文档请参考 <a href="https://docs.angularjs.org/api/ng/service/$compile">AngularJS 官方文档</a>。</p>

<p>另外，我们使用 DOM 源生的事件来触发按钮的 <code>onClick</code> 回调，从而把这个 Directive 当做一个黑盒子来测试。另外我们可以看到，在 Directive 内部，<code>myCallback</code> 被重命名为 <code>callback</code>，从 Directive 内部，我们只能通过 <code>callback</code> 来存取这个回调。原本我们可以像下面这样写测试代码：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;click callback&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mySpy</span><span class="p">;</span>

        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">mySpy</span> <span class="o">=</span> <span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span><span class="p">();</span>
            <span class="nx">innerScope</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="nx">mySpy</span><span class="p">;</span>
        <span class="p">});</span>

        <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;when the directive is clicked&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s2">&quot;MouseEvent&quot;</span><span class="p">);</span>
                <span class="nx">event</span><span class="p">.</span><span class="nx">initMouseEvent</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">element</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be called&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">expect</span><span class="p">(</span><span class="nx">mySpy</span><span class="p">.</span><span class="nx">callCount</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span></code></pre></div>

<p>上面这段代码仍然可以工作，可问题在于我们引用了 Directive 内部的状态，这样如果 Directive在内部把它的事件回调改为别的名字，相应的我们也要更新测试代码；另一个问题是这样一来，我们没有把 Directive 当成黑盒子来测试，我们必须要为我们事实上并不关心的内部状态编写测试代码。</p>

<h3 id="provider">测试 Provider</h3>

<p>对 Provider 的测试相对复杂，我会在随后用一篇新的文章来解释 Provider 是什么，以及如何测试它。</p>

<h3 id="http-">测试 HTTP 请求</h3>

<p>HTTP 是 Web 应用中不可或缺的一环，所以了解如何测试 HTTP 请求也很重要。在应用程序中，常见的 HTTP 请求有 <code>GET</code>, <code>POST</code>, <code>PUT</code>, <code>DELETE</code>。其中，<code>GET</code> 请求会向应用程序输入一些数据，而另外的三种请求则会向应用程序以外的第三方应用输入一些数据，这也是对于 HTTP 请求我们需要测试的地方。我们来看一个实例：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;HttpRequestExample&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;httpReq&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$http&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">sendMessage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;http://it-ebooks-api.info/v1/search/JavaScript&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}]);</span></code></pre></div>

<p>上面的代码像第三方服务发送了一个 GET 请求，我们需要在测试代码中 Mock 该 HTTP 请求，从而在单元测试中解除对第三方服务的依赖。测试代码如下：</p>

<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">module</span><span class="p">(</span><span class="s1">&#39;HttpRequestExample&#39;</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">httpReq</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">$httpBackend</span><span class="p">;</span>

    <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">inject</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">_httpReq_</span><span class="p">,</span> <span class="nx">_$httpBackend_</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">httpReq</span> <span class="o">=</span> <span class="nx">_httpReq_</span><span class="p">;</span>
        <span class="nx">$httpBackend</span> <span class="o">=</span> <span class="nx">_$httpBackend_</span><span class="p">;</span>
    <span class="p">}));</span>

    <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;when sending a message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">beforeEach</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">expectGET</span><span class="p">(</span><span class="s1">&#39;http://it-ebooks-api.info/v1/search/JavaScript&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">respond</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Ook.&#39;</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span>

            <span class="nx">httpReq</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">();</span>
            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should send an HTTP GET request&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">verifyNoOutstandingExpectation</span><span class="p">();</span>
            <span class="nx">$httpBackend</span><span class="p">.</span><span class="nx">verifyNoOutstandingRequest</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>

<p>从测试代码中可以看出，<code>$httpBackend</code> 模拟了 HTTP 服务器的实现，并且定义了这个服务器需要响应的请求和响应值，这里我们定义了一个 GET 请求。另外，<code>$httpBackend.flush()</code> 的作用在于我们在真正响应请求之前可以配置响应的一些属性。这个模拟的 HTTP 服务器并不会立即响应请求，它会保持住当前请求，直到你明确的要求它返回响应值。</p>

<p>另外，<code>$httpBackend.verifyNoOutstandingExpectation</code> 和 <code>$httpBackend.verifyNoOutstandingRequest</code> 校验我们所定义的 HTTP 请求和响应都已经被触发，并给出了相应的响应，详细用法可以参见<a href="https://docs.angularjs.org/api/ngMock/service/$httpBackend">angular-mocks 的文档</a>。</p>

<h3 id="ngmock-">ngMock 模块简介</h3>

<p>ngMock 模块包含了一系列帮助我们测试 AngularJS 应用程序的工具方法，包括 $timeout, $interval, $log, $httpBackend, inject(…) 等等。其中的一部分我们在前面的单元测试实例中已经见过了。这里我还想再提一下 <code>module(...)</code> 和 <code>inject(...)</code> 两个函数。</p>

<p><a href="https://docs.angularjs.org/api/ngMock/function/angular.mock.module">module(…)</a> 用于在运行测试代码的时候查找和解析依赖，它的用法在前面的测试代码中也可以见到。而 <a href="https://docs.angularjs.org/api/ngMock/function/angular.mock.inject">inject(…)</a> 用于创建一个 <code>$injector</code> 实例，用于解析依赖的引用。</p>

<h2 id="section-2">结论</h2>

<p>AngularJS 的单元测试由于依赖注入的存在是比较容易编写的，这也是因为 AngularJS 在设计之初就把易测试性作为设计的首要目标之一。即便如此，AngularJS 也不能阻止我们作为应用程序开发者做傻事，我们要做的就是理解 AngularJS 的设计理念，做正确的事情。为了帮助我们开发者更好的写测试代码，AngularJS 开发者们为我们提供了 <code>angular-mocks</code> 类库，通过它，我们可以通过依赖注入来解析测试所需要的依赖，比较容易的用测试覆盖我们的代码，从而提高代码质量。</p>

<h2 id="section-3">声明</h2>

<p>本文部分实例代码来自 <a href="http://www.smashingmagazine.com/2014/10/introduction-to-unit-testing-in-angularjs/">An Introduction To Unit Testing In AngularJS Applications</a>。</p>

<h2 id="section-4">资源</h2>

<p><a href="http://www.smashingmagazine.com/2014/10/introduction-to-unit-testing-in-angularjs/">An Introduction To Unit Testing In AngularJS Applications</a></p>

<p><a href="https://www.airpair.com/angularjs/posts/testing-angular-with-karma">Testing AngularJS Apps Using Karma</a></p>

<p><a href="https://angularjs.org/">AngularJS 主页</a></p>

<p><a href="http://karma-runner.github.io/0.8/index.html">Karma 主页</a></p>

<p><a href="http://mochajs.org/">Mocha 主页</a></p>

<p><a href="http://chaijs.com/">Chai 主页</a></p>

<p><a href="http://sinonjs.org/">Sinon 主页</a></p>

<p><a href="https://github.com/jasmine/jasmine">Jasmine</a></p>

<p><a href="http://thejsguy.com/2015/01/12/jasmine-vs-mocha-chai-and-sinon.html">Jasmine vs. Mocha, Chai, and Sinon</a></p>

<p><a href="https://docs.angularjs.org/api/ngMock">ngMock 文档</a></p>

                <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'puffsun'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/javascript/2015/08/23/react-js-hands-on/" data-toggle="tooltip" data-placement="top" title="React.js 初体验">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/kui_sun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/kui.sun.71">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/puffsun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; George's Code Thoughts 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
