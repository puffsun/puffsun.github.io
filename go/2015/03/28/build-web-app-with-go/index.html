<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Yet another tech blog!">

    <title>用 Go 开发 Web 应用 - George's Dream Port</title>

    <link rel="canonical" href="http://codethoughts.info/go/2015/03/28/build-web-app-with-go/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <link href='//fonts.useso.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">George's Dream Port</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About me</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>用 Go 开发 Web 应用</h1>
                    
                    <span class="meta">Posted by George's Dream Port on March 28, 2015</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<h3 id="section">为什么写这篇文章</h3>
<p>学习 Go 语言到今天为止大约花了两周多的业余时间，在学习的过程中，先后参考了<a href="https://gobyexample.com/">Go By Example</a>，用 Go 语言把<a href="https://github.com/puffsun/go_algorithms_data_structures">常规的算法和数据结构</a>实现了一遍，并大致了解了如何用 Go 语言来开发 Web 应用。在学习如何用 Go 语言写 Web 应用的过程中，看到了<a href="https://golang.org/doc/articles/wiki/">一篇 Go 官方的教程</a>，内容非常丰富，当时就有翻译这篇文章的念头。但是我又不想完整的翻译这篇文章，因为原文前半部分对程序讲解得非常详细，如果你知道 Go 的基础知识，很多内容可以跳过，再者我也不希望本文像原文那样长，所以这篇文章相当于我的学习笔记，或者对原文的总结了，如果你觉得本文步伐过大，导致有点蛋疼，那么就请移步<a href="https://golang.org/doc/articles/wiki/">原文</a>。</p>

<h3 id="section-1">内容</h3>

<ol>
  <li>Go 开发环境参考：<a href="https://golang.org/doc/install">安装</a>，<a href="https://golang.org/doc/code.html">Go 项目文件结构</a></li>
  <li>Go 开发 Web 应用的工具类库：<a href="https://golang.org/pkg/net/http/">net/http</a>, <a href="https://golang.org/pkg/html/template/">html/template</a>, <a href="https://golang.org/pkg/regexp/">regexp</a></li>
  <li>Closure</li>
</ol>

<p>在阅读本文之前，你一定要有编程经验，要懂得基本的 Web 开发技术（HTML、HTTP），会使用命令行。</p>

<h3 id="section-2">开始</h3>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src
<span class="nv">$ </span>mkdir gowiki
<span class="nv">$ </span><span class="nb">cd </span>gowiki</code></pre></div>

<p>创建名为 wiki.go 的文件，并键入如下内容：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;fmt&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
<span class="p">)</span></code></pre></div>

<p>在import 的两个 package 里面，<a href="https://golang.org/pkg/io/ioutil/">io/ioutil</a>我们用于从磁盘读写文件，而 <a href="https://golang.org/pkg/fmt/">fmt</a> 将会用于打印内容到标准输出，一般来说就是你键入命令的 Terminal.</p>

<p>接下来定义我们将使用的核心数据结构，以及用于将文件保存至磁盘的方法(method)和从磁盘加载的函数(function)。function 和 method 的主要区别在于 method 是一个面向对象的概念，它可以操作一个对象自身的数据，而且这个数据是隐式传递的；而对 function 而言，所操作的数据是显式作为函数参数传递进来的，详细的解释请见<a href="http://stackoverflow.com/questions/155609/difference-between-a-method-and-a-function">Difference between a method and a function</a>。另外要注意的是，Go 语言没有内置的面向对象概念，但是我们可以用 <code>struct</code> 来模拟面向对象。</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Page</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Title</span> <span class="kt">string</span>
    <span class="nx">Body</span>  <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="nx">save</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="k">return</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Page</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="nx">body</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 实例化一个 struct</span>
    <span class="nx">p1</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="s">&quot;TestPage&quot;</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;This is a sample Page.&quot;</span><span class="p">)}</span>
    <span class="c1">// 保存到磁盘</span>
    <span class="nx">p1</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="c1">// 从磁盘加载</span>
    <span class="nx">p2</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="s">&quot;TestPage&quot;</span><span class="p">)</span>
    <span class="c1">// 打印到标准输出</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">p2</span><span class="p">.</span><span class="nx">Body</span><span class="p">))</span>
<span class="p">}</span></code></pre></div>

<p>如果你对理解以上代码有难度，请移步原文，参考详细的解释。原文是英文的，如果你对英文理解有难度（作为一个程序员，不会英文其实是自废一半以上的武功），那么你可以跟我联系，我也很乐意帮你讲解。</p>

<p>这时候运行代码，就可以看到输出了：</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>go run wiki.go
This is a sample page.</code></pre></div>

<h3 id="go-web-">一个简单的 Go Web 应用</h3>
<p>下面这段代码和上面我们完成的实例没有直接关系，只是用于演示如何用 Go 写 Web 应用。</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;net/http&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hi there, I love %s!&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>可以看到我们在这里给 Web 应用的根路径绑定了一个 HTTP 请求处理器，这个处理器可以提取出请求路径参数，并打印一句包含这个参数的内容到命令行。至于http.ResponseWriter，http.Request，http.HandleFunc，和http.ListenAndServe, 都可以在<a href="https://golang.org/pkg/net/http/">这里</a>找到对应的文档。</p>

<p>假定源文件名为 webapp.go, 这时如果你运行：<code>go run webapp.go</code>, 并访问如下链接，<code>http://localhost:8080/monkeys</code>，那么你将会看到如下输出：<code>Hi there, I love monkeys!</code></p>

<h3 id="nethttp--wiki">使用 net/http 来开发 wiki</h3>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;fmt&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
	<span class="s">&quot;net/http&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Page</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Title</span> <span class="kt">string</span>
    <span class="nx">Body</span>  <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="nx">save</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="k">return</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Page</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="nx">body</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 用于处理以/view/起头的 HTTP 请求</span>
<span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//截取 HTTP 路径参数</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">):]</span>
    <span class="c1">// 加载页面</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="c1">// 打印内容到 HTTP Response</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;&lt;h1&gt;%s&lt;/h1&gt;&lt;div&gt;%s&lt;/div&gt;&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">,</span> <span class="nx">viewHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>在上面的代码里我们看到错误信息被用 <code>_</code> 人为的忽略了，在实际项目中我们绝对不可以这么做，这里只是为了简化代码，后面我们会处理这个返回的错误。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>go run wiki.go</code></pre></div>

<p>访问http://localhost:8080/view/test，你就可以看到页面内容输出了。</p>

<h3 id="wiki">wiki编辑功能</h3>
<p>一个不能编辑内容的 wiki 是没有任何实用价值的，接下来我们就要来开发 wiki 的编辑和保存功能。</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;fmt&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
	<span class="s">&quot;net/http&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Page</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Title</span> <span class="kt">string</span>
    <span class="nx">Body</span>  <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="nx">save</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="k">return</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Page</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="nx">body</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 用于处理以/view/起头的 HTTP 请求</span>
<span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//截取 HTTP 路径参数</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">):]</span>
    <span class="c1">// 加载页面</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="c1">// 打印内容到 HTTP Response</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;&lt;h1&gt;%s&lt;/h1&gt;&lt;div&gt;%s&lt;/div&gt;&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">editHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/edit/&quot;</span><span class="p">):]</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;&lt;h1&gt;Editing %s&lt;/h1&gt;&quot;</span><span class="o">+</span>
        <span class="s">&quot;&lt;form action=\&quot;/save/%s\&quot; method=\&quot;POST\&quot;&gt;&quot;</span><span class="o">+</span>
        <span class="s">&quot;&lt;textarea name=\&quot;body\&quot;&gt;%s&lt;/textarea&gt;&lt;br&gt;&quot;</span><span class="o">+</span>
        <span class="s">&quot;&lt;input type=\&quot;submit\&quot; value=\&quot;Save\&quot;&gt;&quot;</span><span class="o">+</span>
        <span class="s">&quot;&lt;/form&gt;&quot;</span><span class="p">,</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">,</span> <span class="nx">viewHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/edit/&quot;</span><span class="p">,</span> <span class="nx">editHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>有代码洁癖的读者到这里一定感觉到有浓浓的代码坏味道(code smell)扑鼻而来。我们在上面的代码中夹杂了很多 HTML 标签，看着就很恶心。这时候<a href="https://golang.org/pkg/html/template/">html/template</a>就可以派上用场了。利用它，我们可以把 HTML 代码分离出去：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;html/template&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
	<span class="s">&quot;net/http&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Page</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Title</span> <span class="kt">string</span>
    <span class="nx">Body</span>  <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="nx">save</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="k">return</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Page</span> <span class="p">{</span>
    <span class="nx">filename</span> <span class="o">:=</span> <span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
    <span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="nx">body</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 用于处理以/view/起头的 HTTP 请求</span>
<span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//截取 HTTP 路径参数</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">):]</span>
    <span class="c1">// 加载页面</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="c1">// 打印内容到 HTTP Response</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;&lt;h1&gt;%s&lt;/h1&gt;&lt;div&gt;%s&lt;/div&gt;&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">editHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/edit/&quot;</span><span class="p">):]</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">ParseFiles</span><span class="p">(</span><span class="s">&quot;edit.html&quot;</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">,</span> <span class="nx">viewHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/edit/&quot;</span><span class="p">,</span> <span class="nx">editHandler</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>创建名为 <code>edit.html</code> 的新文件：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;h1&gt;</span>Editing <span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/save/&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div&gt;&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;body&quot;</span> <span class="na">rows=</span><span class="s">&quot;20&quot;</span> <span class="na">cols=</span><span class="s">&quot;80&quot;</span><span class="nt">&gt;&lt;/textarea&gt;&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Save&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre></div>

<p>在上面的代码中，<code>template.ParseFiles</code> 读取 <code>edit.html</code> 的内容，并返回<code>*template.Template</code> 实例。<code>t.Execute</code> 运行模板，并将创建的 HTML 内容写入 <code>http.ResponseWriter</code>. 这里 <code>.Title</code> 和 <code>.Body</code> 分别指向 Page 对象里面的 Title 和 Body。</p>

<p>模板被<code>{{}}</code>括起来。<code>http/template</code> 的另外一个好处是它可以自动转义生成的 HTML 代码，避免了 <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> 攻击。</p>

<p>接下来，我们也顺手把 <code>viewHandler</code> 利用 template 清理一下：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">):]</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">ParseFiles</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>view.html 文件内容：</p>

<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;h1&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>[<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/edit/&quot;</span><span class="nt">&gt;</span>edit<span class="nt">&lt;/a&gt;</span>]<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;div&gt;&lt;/div&gt;</span></code></pre></div>

<p>这时候，嗅觉灵敏的读者又会发现，我们在 <code>viewHandler</code> 和 <code>editHandler</code> 里面对 template 的处理逻辑完全一样，本着 <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY</a> 原则，我们这里要将重复的代码移到一个函数(function)里面，请注意，不是方法(method)！</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">tmpl</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">ParseFiles</span><span class="p">(</span><span class="nx">tmpl</span> <span class="o">+</span> <span class="s">&quot;.html&quot;</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">):]</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;view&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">editHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/edit/&quot;</span><span class="p">):]</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<h3 id="section-3">对页面不存在错误的处理</h3>
<p>这时候如果你访问 <code>/view/APageThatDoesntExist</code>，你会发现程序不会按照你预想的路径运行了，这是因为我们之前人为忽略了程序返回的错误码，这时候我们亡羊补牢还来得及，对这种情况，我们将会把页面重定向到新页面的编辑界面：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">):]</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/edit/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;view&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<h3 id="section-4">保存编辑结果</h3>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">saveHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/save/&quot;</span><span class="p">):]</span>
    <span class="nx">body</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">)</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/view/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>保存完毕，页面将会被重定向到查看页面。这里 FormValue 的返回值是 string, 我们利用 <code>[]byte(body)</code> 将其转换到 <code>[]byte</code>.</p>

<h3 id="section-5">错误处理</h3>
<p>在实际项目中，代码的错误需要被恰当的处理，这也就是我们将要做的事情：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">tmpl</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">ParseFiles</span><span class="p">(</span><span class="nx">tmpl</span> <span class="o">+</span> <span class="s">&quot;.html&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">saveHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&quot;/save/&quot;</span><span class="p">):]</span>
    <span class="nx">body</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">)</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/view/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>注意这里 HTTP 错误码的运用。当然我们这里会把错误信息直接抛向用户，这也是很不友好的做法，实际项目中可以根据实际情况自定义友好的4xx和5xx 页面。</p>

<h3 id="section-6">缓存模板</h3>
<p>到目前为止，我们的代码有个重大的性能问题，每一次页面请求都会导致模板重新加载、解析，比较好的做法是在启动时把解析好的模板文件缓存起来。随后请求利用<a href="https://golang.org/pkg/html/template/#Template.ExecuteTemplate">ExecuteTemplate</a>来渲染模板：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="c1">// 全局变量</span>
<span class="kd">var</span> <span class="nx">templates</span> <span class="p">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">ParseFiles</span><span class="p">(</span><span class="s">&quot;edit.html&quot;</span><span class="p">,</span> <span class="s">&quot;view.html&quot;</span><span class="p">))</span>

<span class="kd">func</span> <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">tmpl</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">templates</span><span class="p">.</span><span class="nx">ExecuteTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">tmpl</span><span class="o">+</span><span class="s">&quot;.html&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>我们这里，模板的名字就是模板的文件名，因此在 <code>renderTemplate</code> 方法中我们需要拼接出完整的文件名。</p>

<h3 id="section-7">正则表达式校验</h3>
<p>到目前为止，我们的代码存在一个重大的安全问题，用户可以在浏览器中输入任何路径来读写服务器硬盘，这时候利用正则表达式校验用户输入就可以派上用场了。</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;html/template&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
	<span class="s">&quot;net/http&quot;</span>
	<span class="s">&quot;regexp&quot;</span>
	<span class="s">&quot;errors&quot;</span>
<span class="p">)</span>

<span class="c1">// 用正则表达式匹配，并捕捉用户输入的路径参数，保证参数中只包含大小写字母和数字</span>
<span class="kd">var</span> <span class="nx">validPath</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">MustCompile</span><span class="p">(</span><span class="s">&quot;^/(edit|save|view)/([a-zA-Z0-9]+)$&quot;</span><span class="p">)</span>

<span class="kd">func</span> <span class="nx">getTitle</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nx">validPath</span><span class="p">.</span><span class="nx">FindStringSubmatch</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">m</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;Invalid Page Title&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// The title is the second subexpression.</span>
    <span class="k">return</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getTitle</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/edit/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;view&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">editHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getTitle</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">saveHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">title</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getTitle</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">body</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">)</span>
    <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span>
    <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/view/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<h3 id="section-8">利用闭包来去除重复代码</h3>
<p>仔细观察上面的代码，我们在每个处理器中的错误处理代码几乎一模一样。如果我们把错误处理代码集中起来，并在这个函数(function)中返回 <code>view</code>, <code>edit</code>, 和 <code>save</code> 处理器，那么就可以去除不少重复代码。Go 语言的 <a href="https://golang.org/ref/spec#Function_literals">function literals</a> 在这里可以帮助我们。我们知道 Go 语言中函数(function)是一等公民，这有别于 Java/C# 等语言。</p>

<p>修改后的处理器函数签名如下：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="kd">func</span> <span class="nx">editHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="kd">func</span> <span class="nx">saveHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>

<span class="c1">// 代码和 getTitle 基本相似</span>
<span class="kd">func</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kt">string</span><span class="p">))</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">m</span> <span class="o">:=</span> <span class="nx">validPath</span><span class="p">.</span><span class="nx">FindStringSubmatch</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">m</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">http</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">fn</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>从 <code>makeHandler</code> 中返回的闭包从HTTP 访问路径中抽取了 <code>title</code> 参数，随后通过正则表达式校验了它的内容。</p>

<p>最终完整的，可运行的代码如下：</p>

<div class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&quot;flag&quot;</span>
	<span class="s">&quot;html/template&quot;</span>
	<span class="s">&quot;io/ioutil&quot;</span>
	<span class="s">&quot;log&quot;</span>
	<span class="s">&quot;net&quot;</span>
	<span class="s">&quot;net/http&quot;</span>
	<span class="s">&quot;regexp&quot;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">templates</span> <span class="p">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">Must</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">ParseFiles</span><span class="p">(</span><span class="s">&quot;edit.html&quot;</span><span class="p">,</span> <span class="s">&quot;view.html&quot;</span><span class="p">))</span>
	<span class="nx">validPath</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">MustCompile</span><span class="p">(</span><span class="s">&quot;^/(edit|save|view)/([a-zA-Z0-9]+)$&quot;</span><span class="p">)</span>
	<span class="nx">addr</span>      <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">Bool</span><span class="p">(</span><span class="s">&quot;addr&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&quot;find open address and print to final-port.txt&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Page</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Title</span> <span class="kt">string</span>
	<span class="nx">Body</span>  <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="nx">save</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">filename</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
	<span class="k">return</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="mo">0600</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Page</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">filename</span> <span class="o">:=</span> <span class="nx">title</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
	<span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="nx">body</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">viewHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/edit/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;view&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">editHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">loadPage</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">saveHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">title</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">body</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;body&quot;</span><span class="p">)</span>
	<span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Page</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">Body</span><span class="p">:</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">body</span><span class="p">)}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">http</span><span class="p">.</span><span class="nx">Redirect</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="s">&quot;/view/&quot;</span><span class="o">+</span><span class="nx">title</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusFound</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">tmpl</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span><span class="nx">Page</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">templates</span><span class="p">.</span><span class="nx">ExecuteTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">tmpl</span><span class="o">+</span><span class="s">&quot;.html&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kt">string</span><span class="p">))</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">m</span> <span class="o">:=</span> <span class="nx">validPath</span><span class="p">.</span><span class="nx">FindStringSubmatch</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">m</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">http</span><span class="p">.</span><span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">fn</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
	<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/view/&quot;</span><span class="p">,</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="nx">viewHandler</span><span class="p">))</span>
	<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/edit/&quot;</span><span class="p">,</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="nx">editHandler</span><span class="p">))</span>
	<span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/save/&quot;</span><span class="p">,</span> <span class="nx">makeHandler</span><span class="p">(</span><span class="nx">saveHandler</span><span class="p">))</span>

	<span class="k">if</span> <span class="o">*</span><span class="nx">addr</span> <span class="p">{</span>
		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1:0&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="s">&quot;final-port.txt&quot;</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">Addr</span><span class="p">().</span><span class="nx">String</span><span class="p">()),</span> <span class="mo">0644</span><span class="p">)</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{}</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>

<p>运行 <code>go run wiki.go</code>, 并访问 <code>http://localhost:8080</code>，你就会发现一个崭新的可以用来编辑、保存、查看的 wiki 了。</p>

<p>完整可运行的代码可见<a href="https://github.com/puffsun/gowiki">我的 GitHub 代码库</a>.</p>

<h3 id="section-9">可以继续完善的地方</h3>

<ul>
  <li>把模板保存到 <code>tmpl/</code> 下，把页面保存到 <code>views</code>下，把程序生成的数据保存到 <code>data/</code> 下；</li>
  <li>为 wiki 增加根路径处理器，导航到 /view/FrontPage</li>
  <li>为页面增加一些 CSS，使页面美观一些</li>
  <li>简化站内页面之间的导航，就像其他的功能完备的 wiki 一样，支持 <code>[PageName]</code> 导航到 <code>&lt;a href="/view/PageName"&gt;PageName&lt;/a&gt;</code>, 可以尝试使用 <code>regexp.ReplaceAllFunc</code> 来实现这个功能。</li>
</ul>

<h3 id="section-10">资源</h3>

<ol>
  <li><a href="https://golang.org/doc/articles/wiki/">Writing Web Applications with Go</a></li>
  <li><a href="https://golang.org/pkg/">Go Packages</a></li>
  <li><a href="https://gobyexample.com/">Go by Example</a></li>
  <li><a href="https://github.com/puffsun/go_algorithms_data_structures">Go Algorithms and Data Structures - by George</a></li>
  <li><a href="https://github.com/puffsun/gowiki">GoWiki完整源代码</a></li>
</ol>


                <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'puffsun'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/learn/2015/03/22/10-step-learning-process/" data-toggle="tooltip" data-placement="top" title="快速学习新技能">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="https://twitter.com/kui_sun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/puffsun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/puffsun">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Copyright &copy; George's Dream Port 2015</p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>


</body>

</html>
